{%- comment -%}
Radio include â€” builds a client-side playlist from site pages/posts and initializes
music-player-module.js in "radio" mode so the browser behaves like a radio.

Usage:
{% include player-radio.html parent_name="bhakti" %}
or
{% include player-radio.html %}  <-- uses all audio files (no parent filter)

Gathered fields from pages/posts: title, section (parent), audio_id, audio_length (optional).
If audio_length is missing we use a DEFAULT_TRACK_LENGTH fallback (seconds).
{%- endcomment -%}

{%- assign parent = include.parent_name | default: "" -%}

<div class="music-player-wrapper"
     aria-label="Radio player"
     data-radio-parent="{{ parent | escape}}">
</div>

<script type="module">
  import initMusicPlayer from '/assets/js/music-player-module.js';

  // Build TRACKS array incrementally (only include items that have a section)
  const TRACKS = [];
  {%- comment -%} pages {% endcomment -%}
  {%- for p in site.pages -%}
    {%- if p.audio_id and p.audio_id != "" and p.section and p.section != "" -%}
      {%- capture _url -%}
        {{ '/assets/audio/' | relative_url }}{{ p.section }}/{{ p.audio_id }}.mp3
      {%- endcapture -%}
      {%- assign d = p.audio_length | default: p.audio_duration | default: p.duration -%}
  TRACKS.push({
    title: {{ p.title | default: p.data.title | default: p.audio_id | jsonify }},
    parent: {{ p.section | jsonify }},
    audio_id: {{ p.audio_id | jsonify }},
    url: {{ _url | strip | jsonify }},
    duration: {{ d and d != ""  ? d | replace: ',', '' : 'null' }}
  });
    {%- endif -%}
  {%- endfor -%}

  {%- comment -%} posts (if any) {% endcomment -%}
  {%- if site.posts -%}
    {%- for p in site.posts -%}
      {%- if p.audio_id and p.audio_id != "" and p.section and p.section != "" -%}
        {%- capture _url -%}
          {{ '/assets/audio/' | relative_url }}{{ p.section }}/{{ p.audio_id }}.mp3
        {%- endcapture -%}
        {%- assign d = p.audio_length | default: p.audio_duration | default: p.duration -%}
  TRACKS.push({
    title: {{ p.title | default: p.data.title | default: p.audio_id | jsonify }},
    parent: {{ p.section | jsonify }},
    audio_id: {{ p.audio_id | jsonify }},
    url: {{ _url | strip | jsonify }},
    duration: {{ d and d != ""  ? d | replace: ',', '' : 'null' }}
  });
      {%- endif -%}
    {%- endfor -%}
  {%- endif -%}

  (function(){
    const DEFAULT_TRACK_LENGTH = 1800; // seconds fallback for missing durations
    const wrapper = document.querySelector('.music-player-wrapper[data-radio-parent="{{ parent | escape}}"]');
    if (!wrapper) return;

    // normalize requested parent (trim + lowercase) or null if empty
    const parentRaw = (wrapper.dataset.radioParent || '').toString();
    // Use the provided parent value exactly (case-sensitive). Do not normalize.
    const parentName = parentRaw !== '' ? parentRaw : null;

    // If parentName provided, perform case-sensitive exact match; else use all tracks
    const playlistSource = parentName
      ? TRACKS.filter(t => t.parent === parentName)
      : TRACKS.slice();

    if (!playlistSource || playlistSource.length === 0) {
      console.warn('Radio: no tracks found for parent:', parentName);
      wrapper.textContent = 'No audio tracks found';
      return;
    }

    // Normalize playlist items for music-player-module.js
    const playlist = playlistSource.map(t => {
      const durRaw = (t.duration === null || t.duration === undefined) ? null : Number(t.duration);
      return {
        src: t.url,
        title: (t.title && String(t.title).trim()) ? t.title : (t.audio_id || 'Untitled'),
        sub: t.parent || '',
        duration: isFinite(durRaw) && durRaw > 0 ? durRaw : null
      };
    });

    // Compute total length using provided durations; missing durations use DEFAULT_TRACK_LENGTH
    const durations = playlist.map(item => (item.duration === null ? DEFAULT_TRACK_LENGTH : item.duration));
    const totalLength = durations.reduce((s, v) => s + v, 0);

    // pick current track and offset from Unix timestamp (continuous radio cursor)
    const nowSec = Math.floor(Date.now() / 1000);
    const cursor = totalLength > 0 ? (nowSec % totalLength) : 0;

    let acc = 0;
    let selectedIndex = 0;
    let offsetInTrack = 0;
    for (let i = 0; i < durations.length; i++) {
      const d = durations[i];
      if (cursor < acc + d) {
        selectedIndex = i;
        offsetInTrack = cursor - acc;
        break;
      }
      acc += d;
    }

    // initialize music player with playlist and computed position
    const options = {
      mode: 'radio',
      playlist: playlist,
      startIndex: selectedIndex,
      radioStart: offsetInTrack,
      loop: true
    };

    // initMusicPlayer will build UI inside wrapper and load selected track/position
    const player = initMusicPlayer(wrapper, options);

    // Expose debug info on window for inspection
    window._RADIO_PLAYER = { player, playlist, selectedIndex, offsetInTrack, totalLength, parentName };
  })();

</script>
