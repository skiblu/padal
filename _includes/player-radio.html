<script>
    (function(){

      const TRACK_WINDOW = 1800; // seconds per track window
      const SYNC_INTERVAL_MS = 10000; // periodic resync

      const wrapper = document.querySelector('[data-radio="true"][data-parent="{{ parent }}"]');
      if (!wrapper) return;

      const ALL_TRACKS = window.RADIO_TRACKS && Array.isArray(window.RADIO_TRACKS) ? window.RADIO_TRACKS.slice() : [];
      const parentName = wrapper.dataset.parent && wrapper.dataset.parent.trim() !== "" ? wrapper.dataset.parent.trim() : null;
      const TRACKS = parentName ? ALL_TRACKS.filter(t => (t.parent + "") === parentName) : ALL_TRACKS;

      const audio = wrapper.querySelector('.radio-audio');
      const playBtn = wrapper.querySelector('.mp-play');
      const pauseBtn = wrapper.querySelector('.mp-pause');
      const volRange = wrapper.querySelector('.mp-volume-range');
      const volUp = wrapper.querySelector('.mp-vol-up');
      const volDown = wrapper.querySelector('.mp-vol-down');
      const elapsedEl = wrapper.querySelector('.mp-elapsed');
      const titleEl = wrapper.querySelector('.track-title');
      const subEl = wrapper.querySelector('.track-sub');
      const reelLeft = wrapper.querySelector('.reel-left');
      const reelRight = wrapper.querySelector('.reel-right');

      // Optional: create upcoming track display
      let upcomingEl = wrapper.querySelector('.track-upcoming');
      if(!upcomingEl){
        upcomingEl = document.createElement('div');
        upcomingEl.className = 'track-upcoming';
        upcomingEl.style.fontSize = '0.75rem';
        upcomingEl.style.color = '#5b4a30';
        upcomingEl.style.marginTop = '2px';
        wrapper.querySelector('.cassette-label').appendChild(upcomingEl);
      }

      if (!TRACKS || TRACKS.length === 0) {
        titleEl.textContent = "No audio tracks found";
        subEl.textContent = "";
        upcomingEl.textContent = "";
        return;
      }

      function formatTime(sec){
        const m = Math.floor(sec/60);
        const s = Math.floor(sec%60);
        return m + ':' + (s<10?'0'+s:s);
      }

      // Deterministic selection: pick track on page load / refresh only
      let currentTrackIndex = Math.floor(Date.now() / 1000 / TRACK_WINDOW) % TRACKS.length;
      let currentTrack = TRACKS[currentTrackIndex];

      function nextTrackIndex(){
        return (currentTrackIndex + 1) % TRACKS.length;
      }

      function playTrack(track){
        audio.pause();
        audio.src = track.url;
        titleEl.textContent = track.title || track.audio_id;
        subEl.textContent = track.parent || '';
        // show upcoming track
        const nextTrack = TRACKS[nextTrackIndex()];
        upcomingEl.textContent = "Upcoming: " + (nextTrack.title || nextTrack.audio_id);

        audio.addEventListener('loadedmetadata', function metaHandler(){
          audio.currentTime = 0;
          audio.play().catch(()=>{});
          audio.removeEventListener('loadedmetadata', metaHandler);
        });
      }

      audio.addEventListener('ended', ()=>{
        // loop to next track
        currentTrackIndex = nextTrackIndex();
        currentTrack = TRACKS[currentTrackIndex];
        playTrack(currentTrack);
      });

      // Reels
      let reelTimer = null;
      function startReels(){
        if (reelTimer) return;
        let angle = 0;
        reelTimer = setInterval(()=>{
          angle = (angle + 6 + Math.random()*2) % 360;
          reelLeft.style.transform = `rotate(${angle}deg)`;
          reelRight.style.transform = `rotate(${360-angle}deg)`;
        }, 40);
      }
      function stopReels(){
        if (!reelTimer) return;
        clearInterval(reelTimer);
        reelTimer = null;
      }

      // Update elapsed
      const elapsedTimer = setInterval(()=>{
        elapsedEl.textContent = formatTime(audio.currentTime);
      }, 1000);

      // UI controls
      playBtn.addEventListener('click', ()=>{
        playTrack(currentTrack);
        playBtn.style.display = 'none';
        pauseBtn.style.display = '';
        startReels();
      });
      pauseBtn.addEventListener('click', ()=>{
        audio.pause();
        playBtn.style.display = '';
        pauseBtn.style.display = 'none';
        stopReels();
      });

      // Volume
      audio.volume = 1;
      volRange.value = audio.volume;
      volRange.addEventListener('input', e=>{ audio.volume = e.target.value; });
      volUp.addEventListener('click', ()=>{ audio.volume=Math.min(1,audio.volume+0.1); volRange.value=audio.volume; });
      volDown.addEventListener('click', ()=>{ audio.volume=Math.max(0,audio.volume-0.1); volRange.value=audio.volume; });

    })();
</script>
