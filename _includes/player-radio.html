{%- comment -%}
Radio include â€” builds a client-side playlist from site pages and initializes
music-player-module.js in "radio" mode so the browser behaves like a radio.

Usage:
{% include player-radio.html parent_name="bhakti" %}
or
{% include player-radio.html %}  <-- uses all audio files

Gathered fields from pages: title, section (parent), audio_id, audio_length (optional).
If audio_length is missing we use a DEFAULT_TRACK_LENGTH fallback (seconds).
{%- endcomment -%}

{%- assign parent = include.parent_name | default: "" -%}

<div class="music-player-wrapper"
     aria-label="Radio player"
     data-radio-parent="{{ parent | escape }}">
</div>

<script type="module">
  import initMusicPlayer from '/assets/js/music-player-module.js';

  // Build TRACKS array from Jekyll pages (generated at build time)
  const TRACKS = [
  {%- assign all_pages = site.html_pages -%}
  {%- assign first = true -%}
  {%- for p in all_pages -%}
    {%- if p.audio_id and p.audio_id != "" -%}
      {%- if forloop.index0 > 0 %},{% endif -%}
      {
        "title": {{ p.title | jsonify }},
        "parent": {{ p.section | default: p.parent_id | jsonify }},
        "audio_id": {{ p.audio_id | jsonify }},
        "url": "{{ '/assets/audio/' | relative_url }}{{ p.section | default: p.parent_id }}/{{ p.audio_id }}.mp3",
        {%- assign d = p.audio_length | default: p.audio_duration | default: p.duration -%}
        {%- if d and d != "" -%}
        "duration": {{ d | replace: ',', '' }}
        {%- else -%}
        "duration": null
        {%- endif -%}
      }
    {%- endif -%}
  {%- endfor -%}
  ];

  (function(){
    const DEFAULT_TRACK_LENGTH = 1800; // seconds to use when duration missing
    const parentName = (document.querySelector('.music-player-wrapper')?.dataset?.radioParent || '').trim() || null;

    // Filter playlist by parent if provided
    const playlistSource = parentName ? TRACKS.filter(t => String(t.parent) === parentName) : TRACKS.slice();

    if (!playlistSource || playlistSource.length === 0) {
      // fallback UI: init player with empty playlist and show message in console
      console.warn('Radio: no tracks found for parent:', parentName);
      const wrapperEl = document.querySelector('.music-player-wrapper[data-radio-parent="{{ parent | escape}}"]');
      if (wrapperEl) {
        wrapperEl.textContent = 'No audio tracks found';
      }
      return;
    }

    // Normalize playlist items for music-player-module.js
    const playlist = playlistSource.map(t => {
      const dur = (t.duration === null || t.duration === undefined) ? null : Number(t.duration);
      return {
        src: t.url,
        title: t.title || (t.audio_id || '').toString(),
        sub: t.parent || '',
        duration: isFinite(dur) && dur > 0 ? dur : null
      };
    });

    // Compute total length using provided durations; missing durations use DEFAULT_TRACK_LENGTH
    const durations = playlist.map(item => item.duration === null ? DEFAULT_TRACK_LENGTH : item.duration);
    const totalLength = durations.reduce((s, v) => s + v, 0);

    // pick current track and offset from Unix timestamp
    const nowSec = Math.floor(Date.now() / 1000);
    const cursor = totalLength > 0 ? (nowSec % totalLength) : 0;

    let acc = 0;
    let selectedIndex = 0;
    let offsetInTrack = 0;
    for (let i = 0; i < durations.length; i++) {
      const d = durations[i];
      if (cursor < acc + d) {
        selectedIndex = i;
        offsetInTrack = cursor - acc;
        break;
      }
      acc += d;
    }

    // initialize music player with computed playlist and position
    const wrapper = document.querySelector('.music-player-wrapper[data-radio-parent="{{ parent | escape}}"]');
    if (!wrapper) return;

    const options = {
      mode: 'radio',
      playlist: playlist,
      startIndex: selectedIndex,
      radioStart: offsetInTrack,
      loop: true
    };

    // initMusicPlayer will build UI inside wrapper
    const player = initMusicPlayer(wrapper, options);

    // ensure UI reflects playing position (start paused; user can press Play)
    // Optionally auto-start: uncomment next line if autoplay is desired (may be blocked by browser)
    // player.play();

    // expose for debugging
    window._RADIO_PLAYER = { player, playlist, selectedIndex, offsetInTrack, totalLength };
  })();

</script>
