{%- comment -%}
Radio include â€” builds a client-side playlist from site pages/posts and initializes
music-player-module.js in "radio" mode so the browser behaves like a radio.

Usage:
{% include player-radio.html parent_name="bhakti" %}
or
{% include player-radio.html %}  <-- uses all audio files (no parent filter)

Only include items that have section, audio_id and audio_length (no fallbacks).
{%- endcomment -%}

{%- assign parent = include.parent_name | default: "" -%}

<div class="music-player-wrapper"
     aria-label="Radio player"
     data-radio-parent="{{ parent | escape}}">
</div>

<script type="module">
  import initMusicPlayer from '/assets/js/music-player-module.js';

  // Build TRACKS array incrementally (merge pages + posts into a single iterable)
  const TRACKS = [];
  {%- comment -%}
    Combine pages and posts into all_items safely:
    - start with site.pages (always an array)
    - concat site.posts.docs only when site.posts exists to avoid concat errors
  {%- endcomment -%}
  {%- assign all_items = site.pages -%}
  {%- if site.posts and site.posts.docs -%}
    {%- assign all_items = all_items | concat: site.posts.docs -%}
  {%- endif -%}

  {%- for p in all_items -%}
    {%- comment -%}
      Include only items that explicitly have:
        - p.section (non-empty)
        - p.audio_id (non-empty)
        - p.audio_length (non-empty)
      No fallback logic for duration or url.
    {%- endcomment -%}
    {%- if p.section and p.section != "" and p.audio_id and p.audio_id != "" and p.audio_length and p.audio_length != "" -%}
      {%- capture _url -%}{{ '/assets/audio/' | relative_url }}{{ p.section }}/{{ p.audio_id }}.mp3{%- endcapture -%}
  TRACKS.push({
    title: {{ p.title | default: p.data.title | default: p.audio_id | jsonify }},
    parent: {{ p.section | jsonify }},
    audio_id: {{ p.audio_id | jsonify }},
    url: {{ _url | strip | jsonify }},
    duration: {{ p.audio_length | replace: ',', '' }}
  });
    {%- endif -%}
  {%- endfor -%}

  (function(){
    const wrapper = document.querySelector('.music-player-wrapper[data-radio-parent="{{ parent | escape}}"]');
    if (!wrapper) return;

    // Use the provided parent value exactly (case-sensitive). Do not normalize.
    const parentRaw = (wrapper.dataset.radioParent || '').toString();
    const parentName = parentRaw !== '' ? parentRaw : null;

    // If parentName provided, perform case-sensitive exact match; else use all tracks
    const playlistSource = parentName
      ? TRACKS.filter(t => t.parent === parentName)
      : TRACKS.slice();

    if (!playlistSource || playlistSource.length === 0) {
      console.warn('Radio: no tracks found for parent:', parentName);
      wrapper.textContent = 'No audio tracks found';
      return;
    }

    // Normalize playlist items for music-player-module.js
    const playlist = playlistSource.map(t => ({
      src: t.url,
      title: (t.title && String(t.title).trim()) ? t.title : (t.audio_id || 'Untitled'),
      sub: t.parent || '',
      duration: Number(t.duration) // duration guaranteed present (no fallback)
    }));

    // Compute total length directly from provided durations (no defaults)
    const durations = playlist.map(item => Number(item.duration));
    const totalLength = durations.reduce((s, v) => s + v, 0);

    // pick current track and offset from Unix timestamp (continuous radio cursor)
    const nowSec = Math.floor(Date.now() / 1000);
    const cursor = totalLength > 0 ? (nowSec % totalLength) : 0;

    let acc = 0;
    let selectedIndex = 0;
    let offsetInTrack = 0;
    for (let i = 0; i < durations.length; i++) {
      const d = durations[i];
      if (cursor < acc + d) {
        selectedIndex = i;
        offsetInTrack = cursor - acc;
        break;
      }
      acc += d;
    }

    // initialize music player with playlist and computed position
    const options = {
      mode: 'radio',
      playlist: playlist,
      startIndex: selectedIndex,
      radioStart: offsetInTrack,
      loop: true
    };

    // initMusicPlayer will build UI inside wrapper and load selected track/position
    const player = initMusicPlayer(wrapper, options);

    // Expose debug info on window for inspection
    window._RADIO_PLAYER = { player, playlist, selectedIndex, offsetInTrack, totalLength, parentName };
  })();

</script>
