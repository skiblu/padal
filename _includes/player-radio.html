{%- comment -%}
Radio Player Include
Usage:
{% include player-radio.html parent_name="bhakti" %}
If parent_name is empty â†’ scans all audio folders.
{%- endcomment -%}

{%- assign parent = include.parent_name | default: "" -%}

<div class="music-player-wrapper"
     aria-label="Radio player"
     data-radio="true"
     data-parent="{{ parent }}">

    <!-- Hidden audio element -->
    <audio class="radio-audio" preload="metadata" crossorigin="anonymous"></audio>

    <!-- Retro cassette visual (same as music player) -->
    <div class="cassette-player">
        <div class="cassette-shell">

            <div class="cassette-window">
                <div class="reel reel-left" aria-hidden="true"></div>
                <div class="tape" aria-hidden="true"></div>
                <div class="reel reel-right" aria-hidden="true"></div>
            </div>

            <div class="cassette-label">
                <div class="track-title">Online Radio</div>
                <div class="track-sub">
                    {% if parent != "" %}
                    Playlist: {{ parent }}
                    {% else %}
                    Playlist: All Collections
                    {% endif %}
                </div>
            </div>

            <div class="controls-row">
                <button class="mp-btn mp-play" aria-label="Play" title="Play">
                    <img src="{{ '/assets/bootstrap-icons/play.svg' | relative_url }}" alt="">
                </button>

                <button class="mp-btn mp-pause" aria-label="Pause" title="Pause" style="display:none;">
                    <img src="{{ '/assets/bootstrap-icons/pause.svg' | relative_url }}" alt="">
                </button>

                <div class="mp-seek">
                    <input type="range" class="mp-seek-range" min="0" max="100" value="0"
                           aria-label="Seek" disabled>
                </div>

                <div class="mp-times">
                    <span class="mp-elapsed">0:00</span> /
                    <span class="mp-duration">LIVE</span>
                </div>

                <div class="mp-volume">
                    <button class="mp-btn mp-vol-down" aria-label="Decrease volume">
                        <img src="{{ '/assets/bootstrap-icons/volume-down.svg' | relative_url }}" alt="">
                    </button>

                    <input type="range" class="mp-volume-range"
                           min="0" max="1" step="0.01" value="1"
                           aria-label="Volume">

                    <button class="mp-btn mp-vol-up" aria-label="Increase volume">
                        <img src="{{ '/assets/bootstrap-icons/volume-up.svg' | relative_url }}" alt="">
                    </button>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Use the same CSS as music-player -->
<style>
    {{ include_relative player-music-styles.css }}
</style>

<script>
    (function(){

      const wrapper = document.querySelector('[data-radio="true"][data-parent="{{ parent }}"]');
      if (!wrapper) return;

      const audio = wrapper.querySelector('.radio-audio');
      const playBtn = wrapper.querySelector('.mp-play');
      const pauseBtn = wrapper.querySelector('.mp-pause');
      const volRange = wrapper.querySelector('.mp-volume-range');
      const volUp = wrapper.querySelector('.mp-vol-up');
      const volDown = wrapper.querySelector('.mp-vol-down');
      const elapsed = wrapper.querySelector('.mp-elapsed');
      const reelLeft = wrapper.querySelector('.reel-left');
      const reelRight = wrapper.querySelector('.reel-right');

      const parentName = wrapper.dataset.parent.trim();

      /* ----------------------------------------------
       * 1. Build playlist from Jekyll during build
       *    Include front-matter audio_id, section, title
       * ---------------------------------------------- */
      const playlist = window.radio_playlist || []; // should be injected via Jekyll

      if (parentName !== "") {
        playlist = playlist.filter(t => t.section === parentName);
      }

      // total length in seconds
      const totalLength = playlist.reduce((sum, t) => sum + (t.duration || 0), 0);

      // get current global position in seconds
      const now = Math.floor(Date.now() / 1000); // current UNIX timestamp
      const pos = totalLength > 0 ? now % totalLength : 0;

      // pick track & position based on current time only once
      let trackIndex = 0;
      let trackPos = 0;
      let acc = 0;
      for (let i = 0; i < playlist.length; i++) {
        const dur = playlist[i].duration || 0;
        if (pos < acc + dur) {
          trackIndex = i;
          trackPos = pos - acc;
          break;
        }
        acc += dur;
      }

      function loadTrack(index, startTime = 0) {
        const t = playlist[index];
        if (!t) return;
        audio.src = `/assets/audio/${t.section}/${t.audio_id}.mp3`;
        audio.currentTime = startTime;
        audio.play();
        wrapper.querySelector('.track-title').textContent = t.title || "Untitled";
      }

      // playlist loop
      let currentIndex = trackIndex;
      loadTrack(currentIndex, trackPos);

      audio.addEventListener('ended', () => {
        currentIndex = (currentIndex + 1) % playlist.length;
        loadTrack(currentIndex, 0);
      });

      /* ----------------------------------------------
       * PLAY / PAUSE
       * ---------------------------------------------- */
      playBtn.addEventListener('click', () => {
        audio.play();
        playBtn.style.display = 'none';
        pauseBtn.style.display = '';
        startReels();
      });

      pauseBtn.addEventListener('click', () => {
        audio.pause();
        pauseBtn.style.display = 'none';
        playBtn.style.display = '';
        stopReels();
      });

      /* ----------------------------------------------
       * VOLUME
       * ---------------------------------------------- */
      audio.volume = 1;

      volRange.addEventListener('input', e => {
        audio.volume = e.target.value;
      });

      volUp.addEventListener('click', () => {
        audio.volume = Math.min(1, audio.volume + 0.1);
        volRange.value = audio.volume;
      });

      volDown.addEventListener('click', () => {
        audio.volume = Math.max(0, audio.volume - 0.1);
        volRange.value = audio.volume;
      });

      /* ----------------------------------------------
       * Reel animation (same as music-player)
       * ---------------------------------------------- */
      let reelId = null;
      function startReels(){
          let angle = 0;
          stopReels();
          reelId = setInterval(() => {
              angle = (angle + 6 + Math.random()*2) % 360;
              reelLeft.style.transform = `rotate(${angle}deg)`;
              reelRight.style.transform = `rotate(${360-angle}deg)`;
          }, 40);
      }

      function stopReels(){
          if (reelId) clearInterval(reelId);
          reelId = null;
      }

    })();
</script>
