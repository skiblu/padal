{%- comment -%}
Notification Publisher (Ably REST)
{%- endcomment -%}

<div class="push-notify-wrapper">
    <h3>Notify</h3>

    <!-- Notify key and channel/event inputs -->
    <input type="text" id="notify-key" placeholder="Notify Key (e.g. xxxx:yyyy)" />
    <input type="text" id="notify-channel" placeholder="Channel " value="" />
    <input type="text" id="notify-event" placeholder="Event name" />

    <input type="text" id="notify-title" placeholder="Title" />
    <textarea id="notify-message" placeholder="Message"></textarea>

    <button id="notify-send">Publish</button>
    <div id="notify-status" role="status" aria-live="polite"></div>
</div>

<style>
    .push-notify-wrapper {
        background: #fff;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 6px 18px rgba(0,0,0,0.15);
        max-width: 480px;
        margin: 20px auto;
        font-family: Arial, sans-serif;
    }
    .push-notify-wrapper h3 { margin-bottom: 12px; color: #333; }
    .push-notify-wrapper input,
    .push-notify-wrapper textarea {
        width: 100%;
        padding: 10px;
        margin: 8px 0;
        border-radius: 6px;
        border: 1px solid #ccc;
        font-size: 14px;
        box-sizing: border-box;
    }
    .push-notify-wrapper textarea { resize: vertical; height: 100px; }
    .push-notify-wrapper button {
        background: #2575fc;
        color: #fff;
        border: none;
        padding: 10px 14px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 15px;
        transition: 0.18s;
    }
    .push-notify-wrapper button:hover { background: #1a5ae0; }
    #notify-status { margin-top: 10px; font-size: 13px; }
</style>

<script>
document.getElementById("notify-send").addEventListener("click", async function () {
    var statusEl = document.getElementById("notify-status");
    statusEl.style.color = 'black';
    statusEl.textContent = 'Publishing...';

    var notifyKey = document.getElementById("notify-key").value.trim();
    var channel = document.getElementById("notify-channel").value.trim() || 'padal-notification';
    var eventName = document.getElementById("notify-event").value.trim() || '';
    var title = document.getElementById("notify-title").value.trim();
    var message = document.getElementById("notify-message").value.trim();

    if (!notifyKey) {
        statusEl.style.color = 'red';
        statusEl.textContent = 'Notify Key is required.';
        return;
    }
    if (!title && !message) {
        statusEl.style.color = 'red';
        statusEl.textContent = 'Provide at least a title or message.';
        return;
    }

    // If eventName blank, server-side/default logic will handle; we still send an empty name or you can compute a default.
    if (!eventName) {
      // compute default MONTH+DAY (e.g. NOV22)
      var now = new Date();
      var months = ['JAN','FEB','MAR','APR','MAY','JUN','JUL','AUG','SEP','OCT','NOV','DEC'];
      var mon = months[now.getMonth()] || 'EVT';
      var day = String(now.getDate()).padStart(2, '0');
      eventName = mon + day;
    }

    // Build payload: Ably accepts an array of messages
    var payload = [{
      name: eventName,
      data: { title: title, message: message }
    }];

    try {
        // Ably REST publish URL
        var url = 'https://rest.ably.io/channels/' + encodeURIComponent(channel) + '/messages';

        var res = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json;charset=UTF-8',
                'Authorization': 'Basic ' + btoa(notifyKey)
            },
            body: JSON.stringify(payload)
        });

        if (res.ok) {
            statusEl.style.color = 'green';
            statusEl.textContent = 'Published successfully.';
            // clear fields (except notifyKey)
            document.getElementById("notify-title").value = '';
            document.getElementById("notify-message").value = '';
            // optionally keep channel/event
        } else {
            var txt = await res.text().catch(()=>res.statusText);
            statusEl.style.color = 'red';
            statusEl.textContent = 'Publish failed: ' + res.status + ' ' + (txt || res.statusText);
        }
    } catch (err) {
        statusEl.style.color = 'red';
        statusEl.textContent = 'Error: ' + (err && err.message ? err.message : String(err));
    }
});
</script>
